<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ•¸å­—é‡‘å­—å¡”ç–Šç–Šæ¨‚ - äº’å‹•ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            -webkit-touch-callout: none; /* ç¦ç”¨é•·æŒ‰é¸å–® */
            -webkit-user-select: none;   /* ç¦ç”¨æ–‡å­—é¸å– */
            user-select: none;
        }
        body {
            background: radial-gradient(circle, #0f172a 0%, #020617 100%);
            /* é—œéµï¼šç¦ç”¨ç€è¦½å™¨æ‰€æœ‰é è¨­è§¸æ§è¡Œç‚ºï¼ˆå¦‚æ»¾å‹•ã€ç¸®æ”¾ï¼‰ */
            touch-action: none; 
            overflow: hidden;
            color: white;
            position: fixed; /* é˜²æ­¢æ©¡çš®ç­‹å›å½ˆæ•ˆæœ */
            width: 100%;
            height: 100%;
        }
        canvas {
            cursor: crosshair;
            display: block;
            touch-action: none; /* ç¢ºä¿ç•«å¸ƒä¸è§¸ç™¼æ»¾å‹• */
        }
        .ui-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center h-screen font-sans">

    <!-- é ‚éƒ¨è³‡è¨Šä»‹é¢ -->
    <div id="ui-container" class="absolute top-6 left-6 z-10 ui-panel p-5 rounded-2xl shadow-2xl min-w-[280px]">
        <div class="flex justify-between items-start mb-4">
            <div>
                <h1 class="text-xl font-bold text-white leading-tight">æ•¸å­—é‡‘å­—å¡” ğŸ§±</h1>
                <p class="text-xs text-blue-300 font-medium">ç”±ä¸‹è€Œä¸Šæ§‹å»ºé‚è¼¯</p>
            </div>
            <button id="screenshotBtn" class="p-2 bg-blue-500/20 hover:bg-blue-500/40 border border-blue-400/30 rounded-lg transition-all" title="æˆªåœ–ä¿å­˜">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-300"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
            </button>
        </div>
        
        <div class="space-y-3">
            <div class="p-3 bg-blue-500/10 rounded-xl border border-blue-400/20">
                <div class="text-[10px] text-blue-400 font-bold uppercase tracking-wider mb-1">è¦å‰‡</div>
                <div class="text-sm text-gray-200">ä¸Šæ–¹æ•¸å€¼ = ä¸‹æ–¹å…©å¡Šä¹‹å’Œ</div>
            </div>
            <div id="hint-box" class="p-3 bg-yellow-500/10 rounded-xl border border-yellow-400/20">
                <div class="text-[10px] text-yellow-400 font-bold uppercase tracking-wider mb-1">ç›®æ¨™</div>
                <div id="targetText" class="text-md font-bold text-white">å»ºç«‹ä¸€å€‹å®Œæ•´çµæ§‹çš„é‡‘å­—å¡”</div>
            </div>
        </div>

        <button id="resetBtn" class="mt-4 px-4 py-2 bg-red-500/20 hover:bg-red-500/40 text-red-200 border border-red-500/30 rounded-lg transition-colors font-bold w-full text-sm">
            æ¸…é™¤æ‰€æœ‰æœ¨å¡Š
        </button>
    </div>

    <!-- æˆåŠŸæç¤º -->
    <div id="successMessage" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-20 text-center pointer-events-none">
        <div class="text-7xl font-black text-yellow-400 drop-shadow-[0_0_30px_rgba(250,204,21,0.6)] animate-bounce text-stroke-black">ç­”å°äº†ï¼ğŸ†</div>
    </div>

    <!-- åº•éƒ¨æ§åˆ¶æŒ‰éˆ• -->
    <div class="absolute bottom-10 flex flex-col items-center gap-4 z-10 w-full">
        <div class="text-xs font-bold text-blue-300 bg-blue-900/40 px-4 py-1 rounded-full border border-blue-400/20">é»æ“Šæ•¸å­—å¾Œå‘ä¸Šæ‹‰å‹•</div>
        <div class="flex gap-4 bg-black/40 p-5 rounded-[2.5rem] backdrop-blur-2xl border border-white/10 shadow-2xl">
            <button onclick="spawnBlock(1, event)" class="w-14 h-14 bg-blue-500 border-b-4 border-blue-700 rounded-2xl shadow-lg flex items-center justify-center font-black text-white text-2xl active:scale-95 transition-all">1</button>
            <button onclick="spawnBlock(2, event)" class="w-14 h-14 bg-teal-500 border-b-4 border-teal-700 rounded-2xl shadow-lg flex items-center justify-center font-black text-white text-2xl active:scale-95 transition-all">2</button>
            <button onclick="spawnBlock(3, event)" class="w-14 h-14 bg-green-500 border-b-4 border-green-700 rounded-2xl shadow-lg flex items-center justify-center font-black text-white text-2xl active:scale-95 transition-all">3</button>
            <button onclick="spawnBlock(4, event)" class="w-14 h-14 bg-orange-500 border-b-4 border-orange-700 rounded-2xl shadow-lg flex items-center justify-center font-black text-white text-2xl active:scale-95 transition-all">4</button>
            <button onclick="spawnBlock(5, event)" class="w-14 h-14 bg-purple-500 border-b-4 border-purple-700 rounded-2xl shadow-lg flex items-center justify-center font-black text-white text-2xl active:scale-95 transition-all">5</button>
            <button onclick="spawnBlock(9, event)" class="w-14 h-14 bg-pink-500 border-b-4 border-pink-700 rounded-2xl shadow-lg flex items-center justify-center font-black text-white text-2xl active:scale-95 transition-all">9</button>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const resetBtn = document.getElementById('resetBtn');
        const screenshotBtn = document.getElementById('screenshotBtn');
        const successMessage = document.getElementById('successMessage');

        let blocks = [];
        let fireworks = [];
        let draggingBlock = null;
        let offsetX = 0;
        let offsetY = 0;

        const BLOCK_W = 110;
        const BLOCK_H = 55;
        const GROUND_Y_RATIO = 0.7;

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y; this.color = color;
                this.angle = Math.random() * Math.PI * 2;
                this.speed = Math.random() * 6 + 4;
                this.friction = 0.97;
                this.gravity = 0.12;
                this.alpha = 1;
                this.decay = Math.random() * 0.015 + 0.01;
            }
            update() {
                this.speed *= this.friction;
                this.x += Math.cos(this.angle) * this.speed;
                this.y += Math.sin(this.angle) * this.speed + this.gravity;
                this.alpha -= this.decay;
            }
            draw() {
                ctx.save();
                ctx.globalAlpha = Math.max(0, this.alpha);
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, 2.5, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            }
        }

        class Block {
            constructor(x, y, value) {
                this.x = x; this.y = y; this.value = value;
                this.w = BLOCK_W; this.h = BLOCK_H;
                this.isValid = false; 
                this.isNew = true; 
                const colors = { 1:'#3B82F6', 2:'#14B8A6', 3:'#22C55E', 4:'#F59E0B', 5:'#A855F7', 9:'#EC4899' };
                this.baseColor = colors[value] || '#64748b';
            }
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                if (this.isValid) {
                    ctx.shadowBlur = 25; ctx.shadowColor = '#fbbf24';
                    ctx.strokeStyle = '#fbbf24'; ctx.lineWidth = 5;
                } else {
                    ctx.strokeStyle = 'rgba(255,255,255,0.4)'; ctx.lineWidth = 2;
                }
                ctx.fillStyle = this.baseColor;
                ctx.beginPath();
                ctx.roundRect(-this.w/2, -this.h/2, this.w, this.h, 12);
                ctx.fill(); ctx.stroke();
                ctx.fillStyle = '#FFFFFF';
                ctx.font = 'bold 30px system-ui, sans-serif';
                ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.fillText(this.value, 0, 0);
                ctx.restore();
            }
            isPointInside(px, py) {
                return px >= this.x - this.w/2 && px <= this.x + this.w/2 &&
                       py >= this.y - this.h/2 && py <= this.y + this.h/2;
            }
        }

        function spawnBlock(val, event) {
            const rect = event.target.getBoundingClientRect();
            const b = new Block(rect.left + rect.width / 2, rect.top - 60, val);
            blocks.push(b);
        }

        function checkLogic() {
            blocks.forEach(b => b.isValid = false);
            let correctCount = 0;
            blocks.forEach(top => {
                const leftSupport = blocks.find(b => b !== top && !b.isNew && Math.abs(b.y - (top.y + top.h)) < 15 && Math.abs(b.x - (top.x - top.w/2)) < 30);
                const rightSupport = blocks.find(b => b !== top && !b.isNew && Math.abs(b.y - (top.y + top.h)) < 15 && Math.abs(b.x - (top.x + top.w/2)) < 30);
                if (leftSupport && rightSupport && (leftSupport.value + rightSupport.value === top.value)) {
                    top.isValid = true;
                    correctCount++;
                }
            });
            if (correctCount >= 1) triggerFirework(correctCount >= 3);
        }

        function triggerFirework(isBigWin) {
            if (!successMessage.classList.contains('hidden')) return;
            if (isBigWin) {
                successMessage.classList.remove('hidden');
                setTimeout(() => successMessage.classList.add('hidden'), 4000);
            }
            let count = 0;
            const burstInterval = setInterval(() => {
                const x = Math.random() * canvas.width;
                const y = Math.random() * canvas.height * 0.5;
                const color = ['#fbbf24', '#f472b6', '#22d3ee', '#a78bfa', '#4ade80'][Math.floor(Math.random()*5)];
                for(let i=0; i < (isBigWin ? 80 : 40); i++) fireworks.push(new Particle(x, y, color));
                if(++count > (isBigWin ? 15 : 4)) clearInterval(burstInterval);
            }, 250);
        }

        // æˆªåœ–
        screenshotBtn.addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = `é‡‘å­—å¡”_${new Date().toLocaleTimeString()}.png`;
            link.href = canvas.toDataURL("image/png");
            link.click();
        });

        // å¹³æ¿æ ¸å¿ƒä¿®æ­£ï¼šå„ªåŒ–è§¸æ§äº‹ä»¶
        const getPointerPos = (e) => {
            const rect = canvas.getBoundingClientRect();
            return {
                x: (e.touches ? e.touches[0].clientX : e.clientX) - rect.left,
                y: (e.touches ? e.touches[0].clientY : e.clientY) - rect.top
            };
        };

        const handleDown = (e) => {
            if (e.type === 'touchstart') e.preventDefault(); // é˜»æ­¢å¹³æ¿æ»¾å‹•
            const pos = getPointerPos(e);
            for (let i = blocks.length - 1; i >= 0; i--) {
                if (blocks[i].isPointInside(pos.x, pos.y)) {
                    draggingBlock = blocks[i];
                    draggingBlock.isNew = false;
                    offsetX = pos.x - draggingBlock.x;
                    offsetY = pos.y - draggingBlock.y;
                    blocks.splice(i, 1);
                    blocks.push(draggingBlock);
                    break;
                }
            }
        };

        const handleMove = (e) => {
            if (!draggingBlock) return;
            if (e.type === 'touchmove') e.preventDefault(); // é˜»æ­¢å¹³æ¿æ»¾å‹•
            const pos = getPointerPos(e);
            draggingBlock.x = pos.x - offsetX;
            draggingBlock.y = pos.y - offsetY;
        };

        const handleUp = () => {
            draggingBlock = null;
            checkLogic();
        };

        // åŒæ™‚ç¶å®šæ»‘é¼ èˆ‡è§¸æ§äº‹ä»¶ï¼Œä¸¦ç¢ºä¿è§¸æ§ä¸è¢«ç€è¦½å™¨æ””æˆª
        canvas.addEventListener('mousedown', handleDown);
        canvas.addEventListener('touchstart', handleDown, { passive: false });
        window.addEventListener('mousemove', handleMove);
        window.addEventListener('touchmove', handleMove, { passive: false });
        window.addEventListener('mouseup', handleUp);
        window.addEventListener('touchend', handleUp);

        function animate() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const groundY = canvas.height * GROUND_Y_RATIO;
            ctx.fillStyle = '#1e293b'; ctx.fillRect(0, groundY, canvas.width, canvas.height - groundY);
            ctx.strokeStyle = '#334155'; ctx.lineWidth = 3;
            ctx.beginPath(); ctx.moveTo(0, groundY); ctx.lineTo(canvas.width, groundY); ctx.stroke();

            blocks.forEach(b => {
                if (b !== draggingBlock && !b.isNew) {
                    let targetY = groundY - b.h/2;
                    for (let other of blocks) {
                        if (other === b || other.isNew) continue;
                        if (Math.abs(b.x - other.x) < b.w * 0.9 && b.y < other.y) {
                            let potY = other.y - b.h;
                            if (potY < targetY && potY > b.y - 40) targetY = potY;
                        }
                    }
                    if (b.y < targetY) b.y += 12;
                    if (b.y > targetY) b.y = targetY;
                }
                b.draw();
            });

            for (let i = fireworks.length - 1; i >= 0; i--) {
                fireworks[i].update(); fireworks[i].draw();
                if (fireworks[i].alpha <= 0) fireworks.splice(i, 1);
            }
            requestAnimationFrame(animate);
        }

        resetBtn.addEventListener('click', () => { blocks = []; fireworks = []; successMessage.classList.add('hidden'); });
        animate();
    </script>
</body>
</html>